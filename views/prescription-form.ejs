<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Privatrezept erstellen – Medizinisches Cannabis</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <header class="header">
    <div class="logo-container">
      <div class="top-row">
        <img src="/images/wanncannabis-logo-animated.svg" alt="WannCannaBis Logo" class="logo" />
        <span class="title">Medizinisches Cannabis</span>
      </div>
      <span class="subtitle">Ein Unternehmen von WannCannaBis</span>
    </div>
    <nav>
      <% if (currentUser && currentUser.is_admin) { %>
        <a href="/admin" class="nav-link">Dashboard</a>
        <a href="/admin/products" class="nav-link">Sorten verwalten</a>
        <a href="/admin/newsletter" class="nav-link">Newsletter</a>
        <a href="/admin/prescriptions" class="nav-link">Rezepte</a>
      <% } else { %>
        <a href="/showroom" class="nav-link">Showroom</a>
        <a href="/prescriptions/new" class="nav-link">Privatrezept</a>
      <% } %>
      <a href="/inbox" class="nav-link">Nachrichten<span id="unread-badge" class="badge"></span></a>
      <a href="/logout" class="nav-link">Logout</a>
    </nav>
  </header>
  <main class="container">
    <div class="card form-card">
      <h2>Privatrezept erstellen</h2>
      <% if (errors && errors.length > 0) { %>
        <ul class="error-list">
          <% errors.forEach(function(e) { %>
            <li><%= e.msg %></li>
          <% }); %>
        </ul>
      <% } %>
      
<form method="post" action="/prescriptions/new" class="form">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>" />

  <div class="form-section">
    <h3>Allgemeine Angaben</h3>
    <div class="form-group">
      <label for="insurance">Kostenträger</label>
      <input type="text" id="insurance" name="insurance" value="Privat" readonly />
      <small>Privatrezept – Kostenträger ist immer „Privat“.</small>
    </div>
  </div>

  <div class="form-section">
    <h3>Patientendaten</h3>
    <div class="form-group">
      <label for="first_name">Vorname*</label>
      <input
        type="text"
        id="first_name"
        name="first_name"
        required
        value="<%= formData.first_name || '' %>"
      />
    </div>
    <div class="form-group">
      <label for="last_name">Nachname*</label>
      <input
        type="text"
        id="last_name"
        name="last_name"
        required
        value="<%= formData.last_name || '' %>"
      />
    </div>
    <div class="form-group">
      <label for="street">Straße*</label>
      <input
        type="text"
        id="street"
        name="street"
        required
        value="<%= formData.street || '' %>"
      />
    </div>
    <div class="form-group">
      <label for="house_number">Hausnummer*</label>
      <input
        type="text"
        id="house_number"
        name="house_number"
        required
        value="<%= formData.house_number || '' %>"
      />
    </div>
    <div class="form-group">
      <label for="zip_code">Postleitzahl*</label>
      <input
        type="text"
        id="zip_code"
        name="zip_code"
        required
        value="<%= formData.zip_code || '' %>"
      />
    </div>
    <div class="form-group">
      <label for="city">Wohnort*</label>
      <input
        type="text"
        id="city"
        name="city"
        required
        value="<%= formData.city || '' %>"
      />
    </div>
    <div class="form-group">
      <label for="patient_birth">Geburtsdatum*</label>
      <input
        type="date"
        id="patient_birth"
        name="patient_birth"
        required
        value="<%= formData.patient_birth || '' %>"
      />
    </div>
    <div class="form-group">
      <label for="insurance_number">Versicherten-Nr.</label>
      <input
        type="text"
        id="insurance_number"
        name="insurance_number"
        value="<%= formData.insurance_number || '' %>"
      />
    </div>
  </div>

  <div class="form-section">
    <h3>Praxis / Arzt</h3>
    <div class="form-group">
      <label for="doctor_practice">Betriebsstätten-Nr.</label>
      <input
        type="text"
        id="doctor_practice"
        name="doctor_practice"
        value="<%= formData.doctor_practice || '' %>"
      />
    </div>
    <div class="form-group">
      <label for="doctor_number">Arzt-Nr.*</label>
      <input
        type="text"
        id="doctor_number"
        name="doctor_number"
        required
        value="<%= formData.doctor_number || '' %>"
      />
    </div>
    <div class="form-group">
      <label>Rezeptdatum (letzter Werktag)</label>
      <div class="readonly-field"><%= prescriptionDateDisplay %></div>
    </div>
  </div>

  <div class="form-section">
    <h3>Indikation</h3>
    <div class="form-group">
      <label>Grund für das Privatrezept*</label>
      <div class="radio-group">
        <label>
          <input type="radio" name="indication" value="Schmerzen"
            <%= formData.indication === 'Schmerzen' ? 'checked' : '' %> />
          Schmerzen
        </label>
        <label>
          <input type="radio" name="indication" value="Schlaflosigkeit"
            <%= formData.indication === 'Schlaflosigkeit' ? 'checked' : '' %> />
          Schlaflosigkeit
        </label>
        <label>
          <input type="radio" name="indication" value="Stress"
            <%= formData.indication === 'Stress' ? 'checked' : '' %> />
          Stress
        </label>
        <label>
          <input type="radio" name="indication" value="Appetitlosigkeit"
            <%= formData.indication === 'Appetitlosigkeit' ? 'checked' : '' %> />
          Appetitlosigkeit
        </label>
        <label>
          <input type="radio" name="indication" value="Sonstiges"
            <%= formData.indication === 'Sonstiges' ? 'checked' : '' %> />
          Sonstiges
        </label>
      </div>
    </div>
    <div class="form-group">
      <label for="indication_other">Sonstiges (optional)</label>
      <input
        type="text"
        id="indication_other"
        name="indication_other"
        value="<%= formData.indication_other || '' %>"
      />
    </div>
    <div class="form-group">
      <label>Vorherige Cannabis-Verordnung?</label>
      <div class="radio-group">
        <label>
          <input type="radio" name="previous_cannabis" value="ja"
            <%= formData.previous_cannabis === 'ja' ? 'checked' : '' %> />
          Ja
        </label>
        <label>
          <input type="radio" name="previous_cannabis" value="nein"
            <%= formData.previous_cannabis === 'nein' ? 'checked' : '' %> />
          Nein
        </label>
      </div>
    </div>
  </div>

  <div class="form-section">
    <h3>Medikation (Cannabisblüten)</h3>
    <p>
      Bitte geben Sie nur die Gesamtmenge in Gramm und die Sorte an. Der Text auf dem Rezept
      wird automatisch im Format:<br />
      „Xg Cannabisblüten, „SorteX“, unzerkleinert, verdampfen/inhalieren,
      Dosierung: ED 0,01g TD 1,00g“ erzeugt.
    </p>
    <div class="form-group">
      <label for="medication_grams">Menge in Gramm*</label>
      <input
        type="number"
        step="0.01"
        min="0.01"
        id="medication_grams"
        name="medication_grams"
        required
        value="<%= formData.medication_grams || '' %>"
      />
    </div>
    <div class="form-group">
      <label for="medication_strain">Cannabissorte*</label>
      <input
        type="text"
        id="medication_strain"
        name="medication_strain"
        required
        value="<%= formData.medication_strain || '' %>"
      />
    </div>
  </div>

  <div class="form-section">
    <h3>Kostenhinweis</h3>
    <div class="form-group">
      <label>
        <input
          type="checkbox"
          id="cost_confirm"
          name="cost_confirm"
          value="ja"
          <%= formData.cost_confirm === 'ja' ? 'checked' : '' %>
        />
        Ich bestätige, dass die Erstellung eines Privatrezeptes 10&nbsp;Euro kostet,
        welche bei Abholung zu bezahlen sind.
      </label>
    </div>
  </div>

  <button type="submit" class="btn">Rezept erstellen</button>
  <a href="<%= currentUser && currentUser.is_admin ? '/admin' : '/showroom' %>" class="btn back-btn">Abbrechen</a>
</form>
    </div>
  </main>
  <footer class="footer">
    <img src="/images/HOOD339_Qualitaetssiegel_silber.svg" alt="Qualitätssiegel" class="seal" />
  </footer>
  <!-- Unread message polling script -->
  <script src="/js/unread.js"></script>
</body>
</html>